<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kabwe Central SDA Church Choir - Enhanced Management System</title>
    <style>
        /* Your existing CSS remains unchanged */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* ... rest of your CSS ... */
    </style>
</head>
<body>
    <div class="container">
        <!-- Your existing HTML structure remains the same -->
        
        <div id="messageArea"></div>
    </div>
    
    <script>
        // ===== GOOGLE SHEETS INTEGRATION =====
        // Replace with your Google Sheets ID (from the URL of your published sheet)
        const SHEET_ID = 'YOUR_GOOGLE_SHEET_ID_HERE';
        
        // Sheet names/tabs in your Google Sheet
        const SHEETS = {
            MEMBERS: 'Members',
            ATTENDANCE: 'Attendance',
            LEAVE: 'LeaveApplications',
            SETTINGS: 'Settings'
        };
        
        // Base URL for Google Sheets API
        const SHEETS_API = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/`;
        
        // Public API key (restrict this in Google Cloud Console)
        const API_KEY = 'YOUR_GOOGLE_API_KEY';
        
        // Function to get data from Google Sheets
        async function getSheetData(sheetName, range = '') {
            try {
                const response = await fetch(`${SHEETS_API}${sheetName}${range}?key=${API_KEY}`);
                const data = await response.json();
                return data.values || [];
            } catch (error) {
                console.error('Error fetching data:', error);
                showMessage('Error loading data. Please check your connection.', 'error');
                return [];
            }
        }
        
        // Function to append data to Google Sheets
        async function appendToSheet(sheetName, values) {
            try {
                const response = await fetch(`${SHEETS_API}${sheetName}:append?valueInputOption=USER_ENTERED&key=${API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        values: [values]
                    })
                });
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Error appending data:', error);
                showMessage('Error saving data. Please try again.', 'error');
                return null;
            }
        }
        
        // Function to update data in Google Sheets
        async function updateSheet(sheetName, range, values) {
            try {
                const response = await fetch(`${SHEETS_API}${sheetName}!${range}?valueInputOption=USER_ENTERED&key=${API_KEY}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        values: [values]
                    })
                });
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Error updating data:', error);
                showMessage('Error updating data. Please try again.', 'error');
                return null;
            }
        }
        
        // Initialize data from Google Sheets
        async function initializeData() {
            try {
                // Load members
                const membersData = await getSheetData(SHEETS.MEMBERS);
                if (membersData.length > 1) {
                    members = membersData.slice(1).map(row => ({
                        id: parseInt(row[0]),
                        name: row[1],
                        phone: row[2],
                        voicePart: row[3],
                        email: row[4],
                        registeredDate: row[5],
                        status: row[6]
                    }));
                    nextMemberId = Math.max(...members.map(m => m.id)) + 1;
                }
                
                // Load attendance
                const attendanceData = await getSheetData(SHEETS.ATTENDANCE);
                if (attendanceData.length > 1) {
                    attendance = attendanceData.slice(1).map(row => ({
                        id: parseInt(row[0]),
                        memberId: parseInt(row[1]),
                        memberName: row[2],
                        date: row[3],
                        serviceType: row[4],
                        status: row[5],
                        timestamp: row[6]
                    }));
                    nextAttendanceId = Math.max(...attendance.map(a => a.id)) + 1;
                }
                
                // Load leave applications
                const leaveData = await getSheetData(SHEETS.LEAVE);
                if (leaveData.length > 1) {
                    leaveApplications = leaveData.slice(1).map(row => ({
                        id: parseInt(row[0]),
                        memberId: parseInt(row[1]),
                        memberName: row[2],
                        startDate: row[3],
                        endDate: row[4],
                        leaveType: row[5],
                        reason: row[6],
                        status: row[7],
                        applicationDate: row[8],
                        adminComments: row[9],
                        reviewedBy: row[10],
                        reviewDate: row[11]
                    }));
                    nextLeaveId = Math.max(...leaveApplications.map(l => l.id)) + 1;
                }
                
                // Load settings
                const settingsData = await getSheetData(SHEETS.SETTINGS);
                if (settingsData.length > 1) {
                    settingsData.slice(1).forEach(row => {
                        if (row[0] === 'adminPassword') settings.adminPassword = row[1];
                        if (row[0] === 'googleSheetUrl') settings.googleSheetUrl = row[1];
                        if (row[0] === 'churchSettings') settings.churchSettings = row[1];
                    });
                }
                
                // Update UI with loaded data
                if (currentUser && isAdmin) {
                    updateAdminDashboard();
                } else if (currentUser) {
                    updateMemberDashboard();
                }
                
            } catch (error) {
                console.error('Error initializing data:', error);
                showMessage('Error loading data. Using local storage as fallback.', 'warning');
                loadFromLocalStorage();
            }
        }
        
        // Replace the saveToGoogleSheets function with this implementation
        async function saveToGoogleSheets(sheetName, data) {
            try {
                let values = [];
                
                switch(sheetName) {
                    case 'members':
                        values = [
                            data.id,
                            data.name,
                            data.phone,
                            data.voicePart,
                            data.email || '',
                            data.registeredDate,
                            data.status
                        ];
                        await appendToSheet(SHEETS.MEMBERS, values);
                        break;
                        
                    case 'attendance':
                        values = [
                            data.id,
                            data.memberId,
                            data.memberName,
                            data.date,
                            data.serviceType,
                            data.status,
                            data.timestamp
                        ];
                        await appendToSheet(SHEETS.ATTENDANCE, values);
                        break;
                        
                    case 'leave_applications':
                        values = [
                            data.id,
                            data.memberId,
                            data.memberName,
                            data.startDate,
                            data.endDate,
                            data.leaveType,
                            data.reason,
                            data.status,
                            data.applicationDate,
                            data.adminComments || '',
                            data.reviewedBy || '',
                            data.reviewDate || ''
                        ];
                        await appendToSheet(SHEETS.LEAVE, values);
                        break;
                }
                
                // Also save to local storage as backup
                saveToLocalStorage();
                
            } catch (error) {
                console.error('Error saving to Google Sheets:', error);
                showMessage('Could not save to cloud. Using local storage.', 'warning');
                saveToLocalStorage();
            }
        }
        
        // Local storage fallback functions
        function saveToLocalStorage() {
            localStorage.setItem('choirMembers', JSON.stringify(members));
            localStorage.setItem('choirAttendance', JSON.stringify(attendance));
            localStorage.setItem('choirLeaveApplications', JSON.stringify(leaveApplications));
            localStorage.setItem('choirSettings', JSON.stringify(settings));
            localStorage.setItem('choirNextIds', JSON.stringify({
                nextMemberId,
                nextAttendanceId,
                nextLeaveId
            }));
        }
        
        function loadFromLocalStorage() {
            const savedMembers = localStorage.getItem('choirMembers');
            const savedAttendance = localStorage.getItem('choirAttendance');
            const savedLeave = localStorage.getItem('choirLeaveApplications');
            const savedSettings = localStorage.getItem('choirSettings');
            const savedIds = localStorage.getItem('choirNextIds');
            
            if (savedMembers) members = JSON.parse(savedMembers);
            if (savedAttendance) attendance = JSON.parse(savedAttendance);
            if (savedLeave) leaveApplications = JSON.parse(savedLeave);
            if (savedSettings) settings = JSON.parse(savedSettings);
            if (savedIds) {
                const ids = JSON.parse(savedIds);
                nextMemberId = ids.nextMemberId;
                nextAttendanceId = ids.nextAttendanceId;
                nextLeaveId = ids.nextLeaveId;
            }
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('attendanceDate').valueAsDate = new Date();
            initializeData();
        });
        
        // Your existing JavaScript code continues here...
        let members = [ /* ... */ ];
        let attendance = [ /* ... */ ];
        let leaveApplications = [ /* ... */ ];
        let currentUser = null;
        let isAdmin = false;
        let nextMemberId = 5;
        let nextAttendanceId = 3;
        let nextLeaveId = 3;
        let settings = { /* ... */ };
        
        // All your existing functions remain the same
        function showMessage(message, type = 'success') { /* ... */ }
        function loginUser() { /* ... */ }
        // ... etc.
    </script>
</body>
</html>
